# 项目代码整理文档

## 一、项目概述

这是一个基于 Flask 的 AI 文章生成器，名为"张飞吃豆芽"。项目能够通过 Google Gemini API 自动生成文章，并支持批量生成、图片插入、自定义样式和 Word 文档导出功能。

## 二、核心功能模块

### 1. 配置管理系统
- **配置文件**: 使用 `config.json` 存储所有配置信息
- **配置类型**:
  - Gemini API 配置（API Key, Base URL, 默认模型）
  - 图片 API 配置（Unsplash, Pexels, Pixabay）
  - ComfyUI 图片生成配置
  - 本地图库配置
  - Pandoc 配置（必填项）
  - 输出目录配置
  - 写作提示词配置
  - 并发任务数配置

### 2. 图片处理系统
- **多图片源支持**: 支持 Unsplash, Pexels, Pixabay, ComfyUI 自动生成, 用户上传, 本地图库
- **图片优先级**: 可配置图片源的使用优先级
- **图片下载**: 支持从各图片平台下载图片
- **用户上传**: 支持用户上传图片用于文章配图
- **ComfyUI 集成**: 支持通过 ComfyUI 工作流自动生成图片
- **本地图库**: 支持本地图片目录管理，可根据标签匹配图片

### 3. 文章生成工作流
- **Gemini API 集成**: 使用 Google Gemini API 生成文章内容
- **批量处理**: 支持同时生成多篇文章
- **并发控制**: 通过线程池控制并发任务数
- **自定义提示词**: 支持自定义写作提示词模板
- **段落摘要**: 为图片生成创建段落摘要
- **内容处理**: 对生成的文章内容进行格式化处理

### 4. 文档生成系统
- **Word 文档生成**: 使用 Pandoc 将 Markdown 转换为 Word 文档
- **图片插入**: 在生成的文档中自动插入图片
- **格式优化**: 对 Markdown 内容进行优化以适应 Word 格式
- **文件管理**: 生成的文档保存在指定输出目录

### 5. 任务管理系统
- **异步处理**: 使用 ThreadPoolExecutor 实现异步任务处理
- **任务跟踪**: 全局任务存储和状态跟踪
- **进度监控**: 实时监控任务进度并提供 API 接口
- **错误重试**: 支持对失败任务进行重试
- **并发控制**: 可配置最大并发任务数

## 三、API 接口清单

### 1. 页面渲染接口
- `GET /` - 写作页面
- `GET /config` - 配置页面
- `GET /history` - 历史记录页面

### 2. 配置管理接口
- `GET /api/config` - 获取配置信息
- `POST /api/config` - 保存配置信息
- `GET /api/models` - 获取可用的 Gemini 模型列表
- `POST /api/test-model` - 测试 Gemini 模型
- `GET /api/check-pandoc` - 检查 Pandoc 配置状态

### 3. 图片处理接口
- `POST /api/test-unsplash` - 测试 Unsplash API 配置
- `POST /api/test-pexels` - 测试 Pexels API 配置
- `POST /api/test-pixabay` - 测试 Pixabay API 配置
- `POST /api/test-comfyui` - 测试 ComfyUI Workflow 配置
- `POST /api/upload-image` - 用户上传图片
- `GET /api/list-local-images` - 列出本地图库中的所有图片
- `GET /api/list-uploaded-images` - 列出用户上传的所有图片
- `POST /api/download-image-from-url` - 从 URL 下载图片到服务器

### 4. 文章生成接口
- `POST /api/generate` - 启动文章生成任务
- `GET /api/generate/status/<task_id>` - 获取生成任务的状态
- `POST /api/generate/retry` - 重试失败的主题

### 5. 文档管理接口
- `GET /api/download/<filename>` - 下载生成的文档
- `GET /api/history` - 获取历史记录

## 四、核心实现方式

### 1. 配置管理实现
- 使用 JSON 文件存储配置信息
- 提供 RESTful API 接口进行配置的读取和保存
- 关键信息（如 API Key）在前端显示时进行保护
- 支持配置更新后的实时生效（如线程池大小调整）

### 2. 图片处理实现
- 实现优先级队列机制，按配置顺序尝试获取图片
- 多种图片源适配器，统一接口处理不同平台的图片获取
- ComfyUI 集成通过 API 调用工作流生成图片
- 图片下载和缓存机制，避免重复下载
- 图片与文章段落的智能匹配

### 3. 文章生成实现
- 使用 Gemini API 生成文章内容
- 支持自定义提示词模板
- 多线程并发处理多个主题
- 任务状态实时跟踪和进度更新
- 错误处理和重试机制

### 4. 文档生成实现
- 使用 Pandoc 将 Markdown 转换为 Word 文档
- 图片在 Markdown 中的位置标记和后续插入
- 文档样式优化和格式调整
- 自动生成文件名并保存到指定目录

### 5. 任务管理实现
- 全局任务存储字典管理所有任务
- 线程锁保证并发安全
- 线程池实现任务并发执行
- 任务状态实时更新和查询
- 任务进度计算和显示

## 五、关键技术点

### 1. 并发处理
- 使用 `ThreadPoolExecutor` 实现多线程并发处理
- 通过全局锁保证任务数据的线程安全
- 支持动态调整线程池大小

### 2. 异步任务管理
- 任务 ID 唯一标识每个生成任务
- 实时进度跟踪和状态更新
- 前端轮询获取任务状态

### 3. 多平台集成
- 集成多个图片平台 API
- ComfyUI 工作流集成
- Pandoc 文档转换工具集成

### 4. 配置管理
- 动态配置加载和保存
- 敏感信息保护
- 配置实时生效

## 六、项目结构

### 前端文件
- `templates/` - HTML 模板文件
- `static/` - CSS 和 JavaScript 静态资源

### 后端文件
- `app.py` - 主应用文件，包含所有核心逻辑
- `config.json` - 配置文件（运行时生成）
- `config.example.json` - 配置示例文件

### 数据目录
- `output/` - 生成的 Word 文档目录
- `uploads/` - 用户上传图片目录
- `pic/` - 本地图库目录

## 七、Google AI 替换为阿里云 AI 方案

### 1. 项目中使用的 Google AI 功能点梳理

#### 1.1 文章生成功能
- **函数**: `generate_article_with_gemini()`
- **用途**: 使用 Gemini API 生成文章内容
- **调用方式**: HTTP POST 请求到 `https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={api_key}`
- **参数**: 主题、自定义提示词、API Key、Base URL、模型名称
- **返回**: 生成的文章内容（Markdown 格式）

#### 1.2 视觉蓝图生成功能
- **函数**: `generate_visual_blueprint()`
- **用途**: 生成用于图像生成的视觉描述蓝图
- **调用方式**: HTTP POST 请求到 `https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={api_key}`
- **参数**: 文章主题、文章内容片段、API Key、Base URL、模型名称
- **返回**: 结构化的视觉描述 JSON

#### 1.3 段落摘要生成功能
- **函数**: `summarize_paragraph_for_image()`
- **用途**: 为文章段落生成用于图像生成的摘要描述
- **调用方式**: HTTP POST 请求到 `https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={api_key}`
- **参数**: 段落文本、文章主题、配置信息（API Key 等）
- **返回**: 中文视觉描述文本

#### 1.4 模型列表获取功能
- **函数**: `get_models()`
- **用途**: 获取可用的 Gemini 模型列表
- **调用方式**: HTTP GET 请求到 `https://generativelanguage.googleapis.com/v1beta/models?key={api_key}`
- **参数**: API Key、Base URL
- **返回**: 可用模型列表

#### 1.5 模型测试功能
- **函数**: `test_model()`
- **用途**: 测试指定的 Gemini 模型是否可用
- **调用方式**: HTTP POST 请求到 `https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={api_key}`
- **参数**: 模型名称、API Key、Base URL
- **返回**: 模型测试结果和响应内容

### 2. 阿里云 AI (Qwen) 兼容性分析

#### 2.1 API 兼容性对比
| 功能 | Google Gemini | Alibaba Cloud Qwen | 兼容性 |
|------|---------------|-------------------|--------|
| 文本生成 | ✅ 支持 | ✅ 支持 | 高 |
| 对话模式 | ✅ 支持 | ✅ 支持 | 高 |
| 参数控制 | ✅ 支持 (temperature, max_tokens等) | ✅ 支持 (相似参数) | 高 |
| 模型选择 | ✅ 多模型 | ✅ 多模型 (Qwen-Max, Qwen-Plus等) | 高 |
| JSON 格式 | ✅ 支持 | ✅ 支持 | 高 |
| API 调用方式 | HTTP REST | HTTP REST | 高 |

#### 2.2 主要差异点
1. **认证方式**:
   - Google: API Key 作为 URL 参数
   - Alibaba: Bearer Token 在 Authorization 头部

2. **请求格式**:
   - Google:
     ```json
     {
       "contents": [{"parts": [{"text": "prompt"}]}]
     }
     ```
   - Alibaba:
     ```json
     {
       "input": {"messages": [{"role": "user", "content": "prompt"}]}
     }
     ```

3. **响应格式**:
   - Google: `candidates[0].content.parts[0].text`
   - Alibaba: `output.text`

4. **模型名称**:
   - Google: `gemini-pro`, `gemini-1.5-pro`, 等
   - Alibaba: `qwen-max`, `qwen-plus`, `qwen-turbo`, 等

### 3. 替换方案实现复杂度评估

#### 3.1 需要修改的代码模块
1. **配置管理模块**
   - 配置字段名称调整（`gemini_api_key` → `aliyun_api_key`）
   - Base URL 默认值调整（`https://generativelanguage.googleapis.com` → `https://dashscope.aliyuncs.com`）
   - 模型名称映射（`gemini-pro` → `qwen-plus` 等）

2. **API 调用模块**
   - 四个核心函数需要重写：
     - `generate_article_with_gemini()` → `generate_article_with_qwen()`
     - `generate_visual_blueprint()` → `generate_visual_blueprint_qwen()`
     - `summarize_paragraph_for_image()` → `summarize_paragraph_qwen()`
     - `get_models()` → `get_qwen_models()`
     - `test_model()` → `test_qwen_model()`

3. **前端配置页面**
   - 修改配置项标签文字（"Gemini API Key" → "阿里云 API Key"）
   - 修改默认 Base URL 提示文字
   - 修改模型选择下拉框选项

#### 3.2 影响范围评估
- **核心功能**: 5个核心AI功能函数（100%需要修改）
- **配置管理**: 1个配置处理函数（100%需要修改）
- **前端界面**: 1个配置页面（100%需要修改）
- **文档说明**: 配置说明、用户指南需要更新

#### 3.3 开发工作量评估
- **后端代码修改**: 中等（约8-12小时）
  - 重写5个核心AI函数
  - 修改配置处理逻辑
  - 调整错误处理和异常情况
- **前端界面调整**: 简单（约2-3小时）
  - 修改配置页面文字标签
  - 更新模型选项列表
- **测试验证**: 中等（约4-6小时）
  - 功能测试
  - 兼容性测试
  - 性能测试
- **文档更新**: 简单（约1-2小时）

### 4. 替换实施建议

#### 4.1 渐进式替换方案
1. **第一阶段**: 保持双API支持
   - 添加阿里云API配置选项
   - 保留原有Google API功能
   - 提供切换开关

2. **第二阶段**: 默认使用阿里云API
   - 将阿里云API设为默认选项
   - 保留Google API作为备选

3. **第三阶段**: 移除Google API依赖
   - 移除Google相关的配置项
   - 清理无用代码

#### 4.2 兼容性考虑
- 保持接口响应格式一致性
- 保留原有的配置项结构，仅添加新字段
- 提供详细迁移文档

#### 4.3 风险控制
- 在开发分支进行修改，不影响主分支
- 保持完整的单元测试覆盖
- 准备回滚方案